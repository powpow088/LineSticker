<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE 貼圖裁切工具</title>
    <meta name="description" content="LINE 貼圖裁切：上傳網格圖，自動切割成獨立貼圖">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="image-processor.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="app-container processor-container">
        <!-- Header -->
        <header class="app-header">
            <h1>✂️ LINE 貼圖裁切工具</h1>
            <p class="subtitle">上傳網格圖 · 去背裁切 · 打包下載</p>
            <nav class="header-nav">
                <a href="index.html" class="btn btn-primary">← 📝 Prompt 產生器</a>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="processor-main">
            <!-- Step 1: Upload -->
            <section id="step1" class="step-section active">
                <div class="step-header">
                    <span class="step-number">1</span>
                    <h2>上傳網格圖片</h2>
                </div>
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-content">
                        <span class="upload-icon">📁</span>
                        <p class="upload-text">拖放圖片到此處</p>
                        <p class="upload-hint">支援 AI 生成的貼圖網格圖</p>
                        <input type="file" id="fileInput" accept="image/*" class="file-input">
                    </div>
                </div>
            </section>

            <!-- Step 2: Grid Setup & Preview -->
            <section id="step2" class="step-section">
                <div class="step-header">
                    <span class="step-number">2</span>
                    <h2>去背裁切</h2>
                    <button id="undoBtn" class="btn btn-sm" title="復原上一步 (Undo)">
                        <span class="btn-icon">↶</span> 復原
                    </button>
                    <button id="resetDebackBtn" class="btn btn-sm" title="清除所有去背操作，重新開始">
                        <span class="btn-icon">🔄</span> 重做
                    </button>
                </div>

                <!-- Grid Settings -->
                <div class="setting-row">
                    <label>網格大小：</label>
                    <select id="gridCols" class="select-input select-small">
                        <option value="1">1 欄</option>
                        <option value="2">2 欄</option>
                        <option value="3" selected>3 欄</option>
                        <option value="4">4 欄</option>
                        <option value="5">5 欄</option>
                        <option value="6">6 欄</option>
                    </select>
                    <span>×</span>
                    <select id="gridRows" class="select-input select-small">
                        <option value="1">1 列</option>
                        <option value="2">2 列</option>
                        <option value="3" selected>3 列</option>
                        <option value="4">4 列</option>
                        <option value="5">5 列</option>
                        <option value="6">6 列</option>
                    </select>
                </div>

                <!-- Legacy Mode -->
                <div class="setting-row" id="legacyModeRow">
                    <label style="display: flex; align-items: center; cursor: pointer; min-width: unset;">
                        <input type="checkbox" id="legacyModeToggle" style="margin-right: 4px;"> 經典綠幕
                    </label>
                </div>

                <!-- Tool Mode -->
                <div class="setting-row" id="toolModeSetting">
                    <div class="btn-group" id="toolBtnGroup">
                        <label class="btn-toggle active" title="魔法棒去背">
                            <input type="radio" name="toolMode" value="wand" checked> 🪄 魔法棒
                        </label>
                        <label class="btn-toggle" title="框選區域清除">
                            <input type="radio" name="toolMode" value="eraser"> ⬜ 框選清除
                        </label>
                    </div>
                    <span class="wand-mode-group" id="wandModeGroup">
                        <div class="btn-group btn-group-sm">
                            <label class="btn-toggle btn-toggle-sm active" title="只對左上角背景色去背">
                                <input type="radio" name="wandColorMode" value="background" checked> 背景色
                            </label>
                            <label class="btn-toggle btn-toggle-sm" title="對點擊位置的任意顏色去背">
                                <input type="radio" name="wandColorMode" value="any"> 任意色
                            </label>
                        </div>
                    </span>
                </div>

                <!-- De-back Tolerance -->
                <div class="setting-row" id="toleranceSetting">
                    <label>去背強度: <span id="toleranceValue">60</span></label>
                    <input type="range" id="toleranceRange" min="10" max="150" value="60"
                        style="width: 120px; vertical-align: middle;">
                    <button id="lockToleranceBtn" class="btn btn-sm" title="鎖定初始去背強度，之後調整滑桿不影響已鎖定的四角去背">確定</button>
                    <span id="lockedToleranceHint" class="tolerance-hint"></span>
                </div>

                <div class="setting-row" id="positionZoomRow">
                    <label>框線位置：</label>
                    <button id="moveLeft" class="btn btn-icon-only">←</button>
                    <button id="moveRight" class="btn btn-icon-only">→</button>
                    <button id="moveUp" class="btn btn-icon-only">↑</button>
                    <button id="moveDown" class="btn btn-icon-only">↓</button>
                    <span class="zoom-group">
                        <label>圖片縮放：</label>
                        <button id="zoomOut" class="btn btn-icon-only" title="縮小">➖</button>
                        <span id="zoomLevel">100%</span>
                        <button id="zoomIn" class="btn btn-icon-only" title="放大">➕</button>
                        <button id="zoomReset" class="btn btn-sm" title="重置縮放">重置</button>
                    </span>
                </div>






                <!-- Canvas with Grid Overlay -->
                <div class="grid-preview-container">
                    <div class="canvas-wrapper" id="canvasWrapper">
                        <canvas id="previewCanvas"></canvas>
                        <div class="grid-overlay" id="gridOverlay">
                            <!-- Grid lines generated by JS -->
                        </div>
                    </div>
                </div>

                <div class="step-footer">
                    <button id="backToUpload" class="btn btn-secondary">
                        <span class="btn-icon">←</span> 重新上傳
                    </button>
                    <button id="cutBtn" class="btn btn-primary btn-lg">
                        <span class="btn-icon">✂️</span> 裁切並下載 ZIP
                    </button>
                </div>
            </section>

            <!-- Step 3: Complete -->
            <section id="step3" class="step-section">
                <div class="step-header">
                    <span class="step-number">✓</span>
                    <h2>裁切完成！</h2>
                </div>
                <div class="complete-area">
                    <div class="complete-icon">🎉</div>
                    <p class="complete-text">已成功裁切 <span id="cutCount">0</span> 張貼圖</p>
                    <p class="complete-hint">ZIP 檔案已下載到您的下載資料夾</p>

                    <!-- Main Image Selection -->
                    <div class="main-select-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" id="enableMainSelect">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-text">手動選擇主圖</span>
                        <span class="toggle-hint" id="mainSelectHint">（目前使用第一張）</span>
                    </div>

                    <p id="mainSelectInstruction" class="select-instruction hidden">👆 點擊下方貼圖選擇作為主圖</p>

                    <div class="preview-grid-small" id="resultPreview">
                        <!-- Cut stickers preview -->
                    </div>

                    <!-- Re-download button -->
                    <button id="redownloadBtn" class="btn btn-secondary hidden" style="margin-top: 16px;">
                        <span class="btn-icon">📦</span> 重新下載 ZIP（含新主圖）
                    </button>
                </div>
                <div class="step-footer">
                    <button id="startOverBtn" class="btn btn-primary">
                        <span class="btn-icon">🔄</span> 處理另一張圖片
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="image-processor.js"></script>
</body>

</html>